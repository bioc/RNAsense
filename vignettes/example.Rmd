---
title: "Vignette for RNAsense package"
output: rmarkdown::html_vignette
fig_width: 8 
fig_height: 6
vignette: >
  %\VignetteIndexEntry{Put the title of your vignette here}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, echo = FALSE}
library(ggplot2)
library(parallel)
library(NBPSeq)
library(qvalue)
library(SummarizedExperiment)
```

```{r read data}
startTime <- Sys.time() # get start time
analyzeConditions <- c("WT", "MZsox")
ini <- TRUE

mydata <- read.csv("zv9_Refseq_WT_MZsox.csv", sep="\t")
# mydata is data in standard format
thCount <- 100
nrcores <- 8

mydata <- SummarizedExperiment(assays=list(mydata=as.matrix(mydata[,-c(1,2)])), rowData = DataFrame(name=mydata[,1], genename=mydata[,2]), colData = DataFrame(condition=do.call(rbind,strsplit(colnames(mydata)[-c(1,2)], "_"))[,1], time=do.call(rbind,strsplit(colnames(mydata)[-c(1,2)], "_"))[,2], replicate=do.call(rbind,strsplit(colnames(mydata)[-c(1,2)], "_"))[,3]))

vec2Keep <- which(vapply(1:dim(mydata)[1],function(i) !Reduce("&",assays(mydata)[[1]][i,]<thCount), c(TRUE)))
mydata <- mydata[vec2Keep,]
times <- unique(sort(as.numeric(colData(mydata)$time)))

# apply fold change detection
resultFC <- RNAsense:::getFC(dataset = mydata, myanalyzeConditions = analyzeConditions, cores = nrcores, mytimes = times)

# generate and output vulcano plot
ggplot(subset(resultFC, FCdetect!="none"), aes(x=logFoldChange, y=-log10(pValue), color=FCdetect)) + xlab("log2(Fold Change)") + geom_point(shape=20)

# apply switch detection
resultSwitch <- RNAsense:::getSwitch(dataset = mydata, experimentStepDetection = "WT", cores = nrcores, mytimes = times)

# collect results
resultCombined <- RNAsense:::combineResults(resultSwitch, resultFC)

RNAsense:::plotSSGS(resultCombined, c(2.5,3,3.5,4,4.5,5,5.5))

#Output gene switch tables
#RNAsense:::outputGeneTables(resultCombined)

endTime <- Sys.time() # get end time
cat(paste0("Finished with Running Time: ", round(as.numeric(as.difftime(endTime-startTime, units = "mins")), digits = 2), " minutes")) 
```
